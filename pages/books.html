<h3>Books</h3>


<button class="btn btn-link" data-toggle="collapse" data-target="#collapse1">Add book</button>
<div id="collapse1" class="panel-collapse collapse">
	<div class="panel-body">
		<form id="add" method="post" action="addBook">
			<div class="form-group">
				<label class="control-label" for='title'>Title</label>
				<input class="form-control" id="title" name="title"/>
			</div>
			<div id="authors"></div>
			<button id="addAuthor" type="button">Add author</button>
			<div class="form-group">
				<button type="submit" class="btn btn-success disabled" disabled>Add book</button>
			</div>
		</form>
	</div>
</div>

<div id="books" class="list-group"></div>
<script>
	var authors=[];
	var chkSubmit=()=>{
		let disabled=$('#title').val()==''||$('.author').length==0;
		$('form#add button[type="submit"]').toggleClass('disabled',disabled).prop('disabled',disabled);
	};
	var populateBooks=()=>{
		lib.server(
			'getBooks',
			[],
			data=>{
				let list=$('#books');
				list.empty();
				data.forEach(
					r=>{
						$('<a/>',{class:'list-group-item clearfix'})
							.append($('<span/>').html(r.display_name))
							.appendTo(list)
						;
					}
				);
			}
		);
	};
	var getAuthors=()=>{
		lib.server(
			'getAuthors',
			[],
			data=>{authors=data;}
		);
	}
	var populateAuthor=(selector)=>{
		authors.forEach(
			r=>{
				$('<option/>',{value:r.author_id}).html(r.display_name).appendTo($(selector));
			}
		);
	}
	$('#title,.author').on('input change',chkSubmit);
	lib.ajaxForm(
		'#add',
		(data)=>{
			let id=data[0].result;
			$('.author').each(
				(index,node)=>{
					lib.server('addAuthorship',{book_id:id,author_id:$(node).val(),seq_num:index+1});
				}
			);
			$('#collapse1').removeClass('in');
			$('#add input').val('');
			populateBooks();
		}
	);
	$('#addAuthor').click(
		()=>{
			let select=$('<select/>',{class:'author'});
			populateAuthor(select);
			$('<div/>')
			.append(select)
			.append($('<button/>',{type:'button',class:'delAuthor'}).html('x'))
			.appendTo('#authors')
			;
			chkSubmit();
		}
	);
	$('#authors').on(
		'click',
		'.delAuthor',
		(e)=>{
			$(event.target).parent().remove();
			chkSubmit();
		}
	);
	lib.clearSql();
	getAuthors();
	populateBooks();
</script>